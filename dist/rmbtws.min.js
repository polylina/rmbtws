/*!******************************************************************************
 * @license
 * Copyright 2015-2017 Thomas Schreiber
 * Copyright 2017-2019      Rundfunk und Telekom Regulierungs-GmbH (RTR-GmbH)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * The source code for this project is available at
 * https://github.com/rtr-nettest/rmbtws
 *****************************************************************************!*/
"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function RMBTTest(e,t){function n(e){void 0!==M&&M===e||(M=e,O=nowMs(),E&&E(e))}function s(e,t,s){var i=(e.test_server_encryption?"wss://":"ws://")+e.test_server_address+":"+e.test_server_port;console.log(i);var u=function(){return{IGNORE:function(){},CALLGLOBALHANDLER:function(e){e&&p.error("connection closed",e),x(1006===e.code?RMBTError.ABNORMALLY_CLOSED:RMBTError.CONNECT_FAILED)},TRYRECONNECT:function(){x(RMBTError.CONNECT_FAILED)}}}();t.onStateEnter(TestState.INIT_DOWN,function(){n(TestState.INIT_DOWN),console.log(t.id+": start short download"),m=_,a(t,k.pretestDurationMs)}),t.onStateEnter(TestState.PING,function(){n(TestState.PING),console.log(t.id+": starting ping"),0===t.id?c(t):t.triggerNextState()}),t.onStateEnter(TestState.DOWN,function(){if(n(TestState.DOWN),A.length>0){var s=r(A,k.downloadThreadsLimitsMbit,!1);U=s.numThreads,I&&(m=s.chunkSize),A=[]}t.id<U?l(t,e.test_duration):(t.socket.onerror=u.IGNORE,t.socket.onclose=u.IGNORE,t.triggerNextState())}),t.onStateEnter(TestState.CONNECT_UPLOAD,function(){n(TestState.INIT_UP),t.socket.onerror=u.IGNORE,t.socket.onclose=u.IGNORE,t.socket.close(),o(t,i,e.test_token,u.CALLGLOBALHANDLER)}),t.onStateEnter(TestState.INIT_UP,function(){m=_,d(t,k.pretestDurationMs)}),t.onStateEnter(TestState.UP,function(){if(n(TestState.UP),A.length>0){var s=r(A,k.uploadThreadsLimitsMbit,!0);D=s.numThreads,I&&(m=s.chunkSize),A=[]}t.id<D?T(t,e.test_duration):(t.socket.onerror=u.IGNORE,t.socket.onclose=u.IGNORE,t.socket.readyState!==WebSocket.CLOSED&&t.socket.close(),t.triggerNextState())}),t.onStateEnter(TestState.END,function(){t.socket.readyState!==WebSocket.CLOSED&&t.socket.close(),0===t.id&&s()}),t.setState(TestState.INIT),n(TestState.INIT),o(t,i,e.test_token,u.CALLGLOBALHANDLER)}function o(e,t,n,s){try{e.socket=new WebSocket(t)}catch(e){return void x(RMBTError.SOCKET_INIT_FAILED)}e.socket.binaryType="arraybuffer",e.socket.onerror=s,e.socket.onclose=s,e.socket.onmessage=function(t){if(0===t.data.indexOf("CHUNKSIZE")){var o=t.data.trim().split(" ");4===o.length?(h=parseInt(o[1]),_=parseInt(o[2]),v=parseInt(o[3])):(h=parseInt(o[1]),_=h),console.log(e.id+": Chunksizes: min "+_+", max: "+v+", default: "+h)}else if(0===t.data.indexOf("RMBTv")){var r=t.data.substring(5).trim();k.client_version=r,0===r.indexOf("1.")?I=!0:0===r.indexOf("0.3")?I=!1:p.warn("unknown server version: "+r)}else"ACCEPT TOKEN QUIT\n"===t.data?e.socket.send("TOKEN "+n+"\n"):"OK\n"===t.data&&e.state===TestState.INIT?console.log(e.id+": Token accepted"):"ERR\n"===t.data?(s(),p.error("got error msg")):0===t.data.indexOf("ACCEPT GETCHUNKS")&&e.triggerNextState()}}function r(e,t,n){G=e.reduce(function(e,t){return e+t}),console.log("total: circa "+G/1e3+" KB/sec"),console.log("total: circa "+8*G/1e6+" MBit/sec");var s=8*G/1e6,o=0;Object.keys(t).forEach(function(e){s>e&&(o=t[e])}),o=Math.min(B,o),console.log("set number of threads to be used in upcoming speed test to: "+o);var r=G/(1e3/(k.measurementPointsTimespan/2));if(r-=r%1024,r=Math.max(_,r),r=Math.min(v,r),console.log("calculated chunksize for upcoming speed test "+r/1024+" KB"),n){var a=Number.POSITIVE_INFINITY;Object.keys(y).forEach(function(e){Math.abs(r-e)<Math.abs(r-a)?("string"==typeof e&&(e=parseInt(e)),a=e):(delete y[e],delete L[e])}),r=a,console.log("fallback to existing chunksize for upcoming speed test "+r/1024+" KB")}return{numThreads:o,chunkSize:r,bytesPerSecs:G}}function a(e,t){var n=e.socket.onmessage,s=nowMs(),o=1,r=0,a=m;!function c(){i(e,o,a,function(i){r+=o*a,console.log(e.id+": "+i);var u=parseInt(i.substring(5));nowMs()-s>t?(A.push(o*a/(u/1e9)),e.socket.onmessage=n):o<8||!I?(o*=2,c()):(a=Math.min(2*a,v),c())})}()}function i(e,t,n,s){var o=e.socket,r=t,a=m*t,i=0,c=null,u=function(e,t){var n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n},l=function(e){if("string"!=typeof e.data){var t=!1;c=null===c?new Uint8Array(e.data):u(c,new Uint8Array(e.data)),i+=e.data.byteLength,c.length===n&&(r--,t=!0),t&&255===c[c.length-1]?(o.onmessage=function(e){var t=e.data;s(t)},o.send("OK\n"),L[n]=c.buffer,c=null):(y.hasOwnProperty(n)||(y[n]=[]),t&&(y[n].length<k.savedChunks&&y[n].push(c.buffer),c=null))}};o.onmessage=l,console.log(e.id+": downloading "+t+" chunks, "+a/1e3+" KB");var d="GETCHUNKS "+t+(n!==h?" "+n:"")+"\n";o.send(d)}function c(e){var t=e.socket.onmessage,n=k.numPings;u(e,function s(o){if(e.result.pings.push(o),n===k.numPings-1&&(b.durationPingMs=(e.result.pings[1].timeNs-e.result.pings[0].timeNs)/1e6*k.numPings,console.log(e.id+": PING phase will take approx "+b.durationPingMs+" ms")),console.log(e.id+": PING "+o.client+" ns client; "+o.server+" ns server"),--n>0)e.socket.onmessage=function(t){"ACCEPT GETCHUNKS GETTIME PUT PUTNORESULT PING QUIT\n"===t.data?u(e,s):p.error("unexpected error during ping test")};else{for(var r=[],a=0;a<e.result.pings.length;a++)r.push(e.result.pings[a].client);N.ping_client_median=Math.median(r),N.ping_client_shortest=Math.min.apply(Math,r);for(var i=[],c=0;c<e.result.pings.length;c++)i.push(e.result.pings[c].server);N.ping_server_median=Math.median(i),N.ping_server_shortest=Math.min.apply(Math,i),console.log(e.id+": median client: "+Math.round(N.ping_client_median/1e3)/1e3+" ms; median server: "+Math.round(N.ping_server_median/1e3)/1e3+" ms"),console.log(e.id+": shortest client: "+Math.round(N.ping_client_shortest/1e3)/1e3+" ms; shortest server: "+Math.round(N.ping_server_shortest/1e3)/1e3+" ms"),e.socket.onmessage=t}})}function u(e,t){var n=void 0,s=void 0,o=function(o){if("PONG\n"===o.data){var r=nowNs();s=r-n,e.socket.send("OK\n")}else if(0===o.data.indexOf("TIME")){var a=new RMBTPingResult;a.client=s,a.server=parseInt(o.data.substring(5)),a.timeNs=n,t(a)}};e.socket.onmessage=o,n=nowNs(),e.socket.send("PING\n")}function l(e,t){var n=e.socket.onmessage,s=0,o=0,r=-1,a=void 0,i=void 0,c=null,u=null;a=window.setInterval(function(){if(null!==c&&r!==o){r=o;var t=nowNs();console.log(e.id+": "+i+"|"+k.measurementPointsTimespan+"|"+t+"|"+o);var l=new Uint8Array(c,c.byteLength-1,1),g=u-d;e.result.down.push({duration:g,bytes:s}),i=t,l[0]>=255&&(console.log(e.id+": received end chunk"),window.clearInterval(a),e.socket.onmessage=function(t){console.log(t.data),e.socket.onmessage=n},e.socket.send("OK\n"))}},k.measurementPointsTimespan);var l=function(e){o++,s+=e.data.byteLength,u=nowNs(),c=e.data};e.socket.onmessage=l;var d=nowNs();e.socket.send("GETTIME "+t+(m!==h?" "+m:"")+"\n")}function d(e,t){var n=e.socket.onmessage,s=nowMs(),o=1,r=0,a=m;window.setTimeout(function(){var e=nowMs(),n=e-s;console.log("diff:"+(n-t)+" ("+(n-t)/t+" %)")},t);!function i(){g(e,o,a,function(c){if(r+=o*a,console.log(e.id+": "+c),nowMs()-s>t){e.socket.onmessage=n;var u=parseInt(c.substring(5));A.push(o*a/(u/1e9))}else{var l=2*a;o<8||!L.hasOwnProperty(l)||!I?(o*=2,i()):(a=Math.min(2*a,v),i())}})}()}function g(e,t,n,s){var o=e.socket;o.onmessage=function(e){0!==e.data.indexOf("OK")&&0!==e.data.indexOf("ACCEPT")&&s(e.data)},console.log(e.id+": uploading "+t+" chunks, "+n*t/1e3+" KB"),o.send("PUTNORESULT"+(I?" "+n:"")+"\n");for(var r=0;r<t;r++){var a=void 0;a=r===t-1?L[n]:y[n][0],o.send(a)}}function T(e,t){var n=e.socket.onmessage,s=G/2/D,o=1.5*G/D,r=document.hidden?o:s,a=function(){r=document.hidden?o:s,console.log("document visibility changed to: "+document.hidden)};document.addEventListener("visibilitychange",a);var i=Math.ceil(G/D/m),c=!1,u=!0,l=-1,d=0,g=function s(){c||(console.log(e.id+": is 7.2 sec in, got data for "+l),l<1e9*t&&d<3e3?(window.setTimeout(s,250),d+=250):(console.log(e.id+": didn't finish, timeout extended by "+d+" ms, last info for "+l),e.socket.onerror=function(){},e.socket.onclose=function(){},e.socket.close(),e.socket.onmessage=n,console.log(e.id+": socket now closed: "+e.socket.readyState),document.removeEventListener("visibilitychange",a),e.triggerNextState()))},T=function t(){if(e.socket.bufferedAmount<r)for(var n=0;n<i;n++)e.socket.send(y[m][n%y[m].length]);if(!u)return!1;setTimeout(t,0)};window.setTimeout(g,1e3*t+200),window.setTimeout(function(){u=!1,e.socket.onclose=function(){},e.socket.send(L[m]),e.socket.send("QUIT\n")},1e3*t),console.log(e.id+": set timeout");var f=1e6*k.measurementPointsTimespan,p=/TIME (\d+) BYTES (\d+)/,v=/TIME (\d+)/,_=function(t){"OK\n"===t.data&&T();var s=p.exec(t.data);if(null!==s){var o={duration:parseInt(s[1]),bytes:parseInt(s[2])};o.duration-l>f&&(l=o.duration,e.result.up.push(o))}else null!==(s=v.exec(t.data))&&(c=!0,console.log("Upload duration: "+s[1]),e.socket.onmessage=n,document.removeEventListener("visibilitychange",a))};e.socket.onmessage=_,e.socket.send("PUT"+(m!==h?" "+m:"")+"\n")}function f(e){return{client_language:"de",client_name:k.client,client_uuid:k.uuid,client_version:k.client_version,client_software_version:k.client_software_version,geoLocations:N.geoLocations,model:k.model,network_type:98,platform:k.platform,product:k.product,pings:N.pings,test_bytes_download:N.bytes_download,test_bytes_upload:N.bytes_upload,test_nsec_download:N.nsec_download,test_nsec_upload:N.nsec_upload,test_num_threads:U,num_threads_ul:D,test_ping_shortest:N.ping_server_shortest,test_speed_download:N.speed_download,test_speed_upload:N.speed_upload,test_token:e.test_token,test_uuid:e.test_uuid,time:N.beginTime,timezone:k.timezone,type:"DESKTOP",version_code:"1",speed_detail:N.speedItems,user_server_selection:k.userServerSelection,loop_uuid:window.loopFirstTestUUID}}var p=log&&log.getLogger?log.getLogger("rmbtws"):console,m=null,v=4194304,_=0,h=4096,I=!1,k=void 0,S=void 0,N=null,w=null,E=null,M=TestState.INIT,O=null,b={durationInitMs:2500,durationPingMs:1e4,durationUpMs:-1,durationDownMs:-1},P=new RMBTIntermediateResult,R=[],y={},L={},C=null,B=0,U=0,D=0,A=[],G=0;this.onError=function(e){w=e},this.onStateChange=function(e){E=e};var x=function(e){if(console.log("error occurred during websocket test:",e),P.error=e,e!==RMBTError.NOT_SUPPORTED&&n(TestState.ERROR),null!==w){var t=w;w=null,t(e)}};this.startTest=function(e){if(void 0===window.WebSocket)return void x(RMBTError.NOT_SUPPORTED);n(TestState.INIT),N=new RMBTTestResult,S.getDataCollectorInfo(),S.obtainControlServerRegistration(function(t){e||(window.loopFirstTestUUID=t.test_uuid),B=parseInt(t.test_numthreads),C=new CyclicBarrier(B),b.durationDownMs=1e3*t.test_duration,b.durationUpMs=1e3*t.test_duration,null!==TestEnvironment.getTestVisualization()&&TestEnvironment.getTestVisualization().updateInfo(t.test_server_name,t.client_remote_ip,t.provider,t.test_uuid);!function(){console.log("got geolocation, obtaining token and websocket address");var e=function(){n(TestState.INIT),N.beginTime=Date.now();for(var e=0;e<B;e++){var o=new RMBTTestThread(C);o.id=e,N.addThread(o.result),s(t,o,function(){console.log("All tests finished"),N.calculateAll(),S.submitResults(f(t),function(){n(TestState.END)},function(){x(RMBTError.SUBMIT_FAILED)})}),R.push(o)}};0===t.test_wait?e():(console.log("test scheduled for start in "+t.test_wait+" second(s)"),n(TestState.WAIT),self.setTimeout(function(){e()},1e3*t.test_wait))}()},function(){x(RMBTError.REGISTRATION_FAILED)})},this.getIntermediateResult=function(){P.status=M;var e=nowNs()/1e6-O;switch(P.diffTime=e/1e3,P.status){case TestState.WAIT:P.progress=0;break;case TestState.INIT:case TestState.INIT_DOWN:case TestState.INIT_UP:P.progress=e/b.durationInitMs;break;case TestState.PING:P.progress=e/b.durationPingMs;break;case TestState.DOWN:P.progress=e/b.durationDownMs;break;case TestState.UP:P.progress=e/b.durationUpMs;break;case TestState.END:P.progress=1;break;case TestState.ERROR:case TestState.ABORTED:P.progress=0}if(isNaN(P.progress)&&(P.progress=0),P.progress=Math.min(1,P.progress),null!==N){if(P.status!==TestState.PING&&P.status!==TestState.DOWN||(P.pingNano=N.ping_server_median),P.status===TestState.DOWN||P.status==TestState.INIT_UP){var t=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(N.threads,function(e){return e.down});P.downBitPerSec=t.speed,P.downBitPerSecLog=(Math.log10(P.downBitPerSec/1e6)+2)/4}if(P.status===TestState.UP||P.status==TestState.INIT_UP){var n=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(N.threads,function(e){return e.up});P.upBitPerSec=n.speed,P.upBitPerSecLog=(Math.log10(P.upBitPerSec/1e6)+2)/4}}return P},this.getState=function(){return"INIT"},function(e,t){k=e,S=t}(e,t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();exports.RMBTTest=RMBTTest;var MockLogger=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"debug",value:function(){}},{key:"error",value:function(){}},{key:"info",value:function(){}},{key:"warn",value:function(){}},{key:"log",value:function(){}}]),e}();
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var RMBTControlServerCommunication=exports.RMBTControlServerCommunication=function(e,r,o){var t=e,n=log&&log.getLogger?log.getLogger("rmbtws"):new MockLogger;return{obtainControlServerRegistration:function(e,i){var s={version:t.version,language:t.language,uuid:t.uuid,type:t.type,version_code:t.version_code,client:t.client,timezone:t.timezone,time:(new Date).getTime(),measurement_server_id:o?o.id:void 0};Object.assign(s,t.additionalRegistrationParameters),"undefined"!=typeof userServerSelection&&userServerSelection>0&&"undefined"!=typeof UserConf&&void 0!==UserConf.preferredServer&&"default"!==UserConf.preferredServer&&(s.prefer_server=UserConf.preferredServer,s.user_server_selection=userServerSelection),fetch(t.controlServerURL+t.controlServerRegistrationResource,{method:"POST",headers:r,body:JSON.stringify(s)}).then(function(e){return e.json()}).then(function(r){var o=new RMBTControlServerRegistrationResponse(r);e(o)}).catch(function(){n.error("error getting testID"),i()})},getDataCollectorInfo:function(){fetch(t.controlServerURL+t.controlServerDataCollectorResource,{method:"GET",headers:r}).then(function(e){return e.json()}).then(function(e){t.product=e.agent.substring(0,Math.min(150,e.agent.length)),t.model=e.product,t.os_version=e.version}).catch(function(){n.error("error getting data collection response")})},submitResults:function(e,o,i){Object.assign(e,t.additionalSubmissionParameters);var s=JSON.stringify(e);console.log("Submit size: "+s.length),console.log("Submitting result to",t.controlServerURL+t.controlServerResultResource),fetch(t.controlServerURL+t.controlServerResultResource,{method:"POST",headers:r,body:s}).then(function(e){return e.json()}).then(function(r){console.log("json response",r),console.log(e.test_uuid),o(!0)}).catch(function(e){console.log("error submitting results",e),n.error("error submitting results"),i(!1)})}}};
"use strict";function RMBTIntermediateResult(){}Object.defineProperty(exports,"__esModule",{value:!0});var TestEnvironment=exports.TestEnvironment=function(){var e=null;return{getTestVisualization:function(){return e},init:function(t){void 0===t&&(t=new TestVisualization),e=t}}}(),TestState={WAIT:"WAIT",INIT:"INIT",INIT_DOWN:"INIT_DOWN",PING:"PING",DOWN:"DOWN",CONNECT_UPLOAD:"CONNECT_UPLOAD",INIT_UP:"INIT_UP",UP:"UP",END:"END",ERROR:"ERROR",ABORTED:"ABORTED",LOCATE:"LOCATE",LOCABORTED:"LOCABORTED",SPEEDTEST_END:"SPEEDTEST_END",QOS_TEST_RUNNING:"QOS_TEST_RUNNING",QOS_END:"QOS_END"};RMBTIntermediateResult.prototype.setLogValues=function(){var e=function(e){return e<1e4?0:(2+Math.log(e/1e6/Math.LN10))/4};this.downBitPerSecLog=e(downBitPerSec),this.upBitPerSecLog=e(upBitPerSec)},RMBTIntermediateResult.prototype.pingNano=-1,RMBTIntermediateResult.prototype.downBitPerSec=-1,RMBTIntermediateResult.prototype.upBitPerSec=-1,RMBTIntermediateResult.prototype.status=TestState.INIT,RMBTIntermediateResult.prototype.progress=0,RMBTIntermediateResult.prototype.downBitPerSecLog=-1,RMBTIntermediateResult.prototype.upBitPerSecLog=-1,RMBTIntermediateResult.prototype.remainingWait=-1;
"use strict";var TestVisualization=function(){function t(t,s){this.successCallback=t,this.errorCallback=s}return t.prototype.setRMBTTest=function(t){},t.prototype.updateInfo=function(t,s,a,l){},t.prototype.setStatus=function(t){if("ERROR"===t||"ABORTED"===t){if(this.errorCallback){var s=this.errorCallback;this.errorCallback=null,s()}}else if("END"===t&&null!==_successCallback){var s=this.successCallback;this.successCallback=null,s()}},t.prototype.startTest=function(){},t}();
"use strict";function RMBTTestThread(t){var e=(log&&log.getLogger?log.getLogger("rmbtws"):new MockLogger,{}),o=t;return{setState:function(t){this.state=t,console.log(this.id+": reached state: "+t);var s=this;o.await(function(){if(console.log(s.id+": all threads reached state: "+t),void 0!==e[t]&&null!==e[t]){(0,e[t])()}else console.log(s.id+": no callback registered for state: "+t)})},onStateEnter:function(t,o){e[t]=o},retriggerState:function(){setState(this.state)},triggerNextState:function(){var t=[TestState.INIT,TestState.INIT_DOWN,TestState.PING,TestState.DOWN,TestState.CONNECT_UPLOAD,TestState.INIT_UP,TestState.UP,TestState.END];if(this.state!==TestState.END){var e=t[t.indexOf(this.state)+1];console.log(this.id+": triggered state "+e),this.setState(e)}},id:-1,socket:null,result:new RMBTThreadTestResult}}function RMBTTestResult(){this.pings=[],this.speedItems=[],this.threads=[]}function RMBTThreadTestResult(){this.down=[],this.up=[],this.pings=[]}function RMBTPingResult(){}Object.defineProperty(exports,"__esModule",{value:!0}),exports.RMBTTestResult=RMBTTestResult;var RMBTTestConfig=exports.RMBTTestConfig=function(){function t(t,e,o){this.language=t,this.controlServerURL=e+"/"+o}return t.prototype.version="0.3",t.prototype.language,t.prototype.uuid="",t.prototype.type="DESKTOP",t.prototype.version_code="0.3",t.prototype.client_version="0.3",t.prototype.client_software_version="0.9.0",t.prototype.os_version=1,t.prototype.platform="RMBTws",t.prototype.model="Websocket",t.prototype.product="Chrome",t.prototype.client="RMBTws",t.prototype.timezone="Europe/Vienna",t.prototype.controlServerURL,t.prototype.controlServerRegistrationResource="adminTestRequest",t.prototype.controlServerResultResource="measurementResult",t.prototype.controlServerDataCollectorResource="requestDataCollector",t.prototype.pretestDurationMs=2e3,t.prototype.savedChunks=4,t.prototype.measurementPointsTimespan=40,t.prototype.numPings=10,t.prototype.downloadThreadsLimitsMbit={0:1,1:3,100:10},t.prototype.uploadThreadsLimitsMbit={0:1,30:2,80:3,150:10},t.prototype.userServerSelection=void 0!==window.userServerSelection?userServerSelection:0,t.prototype.additionalRegistrationParameters={},t.prototype.additionalSubmissionParameters={},t}(),RMBTControlServerRegistrationResponse=function(){function t(t){Object.assign(this,t),this.test_duration=parseInt(t.test_duration)}return t.prototype.client_remote_ip,t.prototype.provider,t.prototype.test_server_encryption="",t.prototype.test_numthreads,t.prototype.test_server_name,t.prototype.test_uuid,t.prototype.test_id,t.prototype.test_token,t.prototype.test_server_address,t.prototype.test_duration,t.prototype.result_url,t.prototype.test_wait,t.prototype.test_server_port,t}();RMBTTestResult.prototype.addThread=function(t){this.threads.push(t)},RMBTTestResult.prototype.ip_local=null,RMBTTestResult.prototype.ip_server=null,RMBTTestResult.prototype.port_remote=null,RMBTTestResult.prototype.num_threads=null,RMBTTestResult.prototype.encryption="NONE",RMBTTestResult.prototype.ping_shortest=-1,RMBTTestResult.prototype.ping_median=-1,RMBTTestResult.prototype.client_version=null,RMBTTestResult.prototype.pings=[],RMBTTestResult.prototype.speed_download=-1,RMBTTestResult.prototype.speed_upload=-1,RMBTTestResult.prototype.speedItems=[],RMBTTestResult.prototype.bytes_download=-1,RMBTTestResult.prototype.nsec_download=-1,RMBTTestResult.prototype.bytes_upload=-1,RMBTTestResult.prototype.nsec_upload=-1,RMBTTestResult.prototype.totalDownBytes=-1,RMBTTestResult.prototype.totalUpBytes=-1,RMBTTestResult.prototype.beginTime=-1,RMBTTestResult.prototype.geoLocations=[],RMBTTestResult.calculateOverallSpeedFromMultipleThreads=function(t,e){for(var o=t.length,s=1/0,r=0;r<o;r++){var p=e(t[r]);p.length>0&&p[p.length-1].duration<s&&(s=p[p.length-1].duration)}for(var n=0,i=0;i<o;i++){var l=t[i],a=e(l),u=a.length;if(null!==l&&u>0){for(var d=u,T=0;T<u;T++)if(a[T].duration>=s){d=T;break}var R=void 0;if(a[d].duration===s)R=a[u-1].bytes;else{var y=0===d?0:a[d-1].bytes,h=a[d].bytes,c=h-y,g=0===d?0:a[d-1].duration,M=a[d].duration,_=M-g,v=s-g,B=v/_,f=Math.round(c*B);f<0&&(f=0),R=y+f}n+=R}}return{bytes:n,nsec:s,speed:8*n/(s/1e9)}},RMBTTestResult.prototype.calculateAll=function(){for(var t=0;t<this.threads.length;t++){var e=this.threads[t].down;if(e.length>0)for(var o=0;o<e.length;o++)this.speedItems.push({direction:"download",thread:t,time:e[o].duration,bytes:e[o].bytes})}var s=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(this.threads,function(t){return t.down});this.speed_download=s.speed/1e3,this.bytes_download=s.bytes,this.nsec_download=s.nsec;for(var r=0;r<this.threads.length;r++){var p=this.threads[r].up;if(p.length>0)for(var n=0;n<p.length;n++)this.speedItems.push({direction:"upload",thread:r,time:p[n].duration,bytes:p[n].bytes})}s=RMBTTestResult.calculateOverallSpeedFromMultipleThreads(this.threads,function(t){return t.up}),this.speed_upload=s.speed/1e3,this.bytes_upload=s.bytes,this.nsec_upload=s.nsec;for(var i=this.threads[0].pings,l=0;l<i.length;l++)this.pings.push({value:i[l].client,value_server:i[l].server,time_ns:i[l].timeNs})},RMBTThreadTestResult.prototype.down=null,RMBTThreadTestResult.prototype.up=null,RMBTThreadTestResult.prototype.pings=null,RMBTThreadTestResult.prototype.totalDownBytes=-1,RMBTThreadTestResult.prototype.totalUpBytes=-1,RMBTPingResult.prototype.client=-1,RMBTPingResult.prototype.server=-1,RMBTPingResult.prototype.timeNs=-1;var RMBTError=exports.RMBTError={NOT_SUPPORTED:"WebSockets are not supported",SOCKET_INIT_FAILED:"WebSocket initialization failed",CONNECT_FAILED:"connection to test server failed",SUBMIT_FAILED:"Error during submission of test results",REGISTRATION_FAILED:"Error during test registration",ABNORMALLY_CLOSED:"Connection closed abnormally"};
"use strict";function nowMs(){return window.performance.now()}function nowNs(){return Math.round(1e6*window.performance.now())}function CyclicBarrier(n){var o=n,e=[],r=function(){var n=e.slice();e=[],self.setTimeout(function(){for(var e=0;e<o;e++)n[e]()},1)};return{await:function(n){e.push(n),e.length===o&&r()}}}!function(){if(Date.now||(Date.now=function(){return(new Date).getTime()}),void 0===window.performance&&(window.performance={}),!window.performance.now||void 0===window.performance.now){var n=Date.now();performance.timing&&performance.timing.navigationStart&&(n=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-n}}}(),Math.median=function(n){n.sort(function(n,o){return n-o});var o=Math.floor(n.length/2);return n.length%2?n[o]:(n[o-1]+n[o])/2},Math.log10=Math.log10||function(n){return Math.log(n)/Math.LN10},self.log=self.log||{debug:function(){var n=void 0;(n=new MockLogger).log.apply(n,arguments)},trace:function(){(new MockLogger).trace()},info:function(){var n=void 0;(n=new MockLogger).info.apply(n,arguments)},warn:function(){var n=void 0;(n=new MockLogger).warn.apply(n,arguments)},error:function(){var n=void 0;(n=new MockLogger).error.apply(n,arguments)},setLevel:function(){},getLogger:function(){return log}},"function"!=typeof Object.assign&&(Object.assign=function(n,o){if(null==n)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(n),r=1;r<arguments.length;r++){var t=arguments[r];if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}),void 0===document.hidden&&(document.hidden=!1);
//# sourceMappingURL=rmbtws.min.js.map
